<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Master AI Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic UI elements -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .dashboard-card {
            @apply bg-white p-6 rounded-xl shadow-lg transition duration-300 hover:shadow-xl border border-gray-100;
        }
        .icon-up { @apply text-green-600; }
        .icon-down { @apply text-red-600; }
        .icon-flat { @apply text-yellow-500; }
        .chat-container {
            transition: all 0.3s ease-in-out;
            max-height: 500px;
        }
        /* Custom scrollbar for chat history */
        .chat-history::-webkit-scrollbar { width: 4px; }
        .chat-history::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 p-4 bg-white rounded-xl shadow-md border-b-4 border-blue-500">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                <svg class="w-8 h-8 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                Stock Master AI
            </h1>
            <p class="text-gray-500 mt-1">Predictive analysis and real-time financial chat assistant.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Stock Analysis Panel (Col Span 2) -->
            <main class="lg:col-span-2">
                <section class="dashboard-card mb-8">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">Stock Search & Analysis</h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="text" id="stockSymbol" placeholder="Enter stock symbol (e.g., RELIANCE, GOOGL)"
                               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg shadow-sm" required>
                        <button id="analyzeButton"
                                class="bg-blue-600 text-white p-3 rounded-lg font-medium hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center disabled:bg-blue-400">
                            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13.75M9 19C7.895 19 7 18.105 7 17s.895-2 2-2 2 .895 2 2-.895 2-2 2zm12 0c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2zM9 17v-1.25M21 17v-1.25"></path></svg>
                            Analyze Stock
                        </button>
                    </div>
                    <p id="messageArea" class="mt-3 text-sm text-red-500 h-5"></p>
                </section>

                <!-- Results Dashboard -->
                <div id="resultsDashboard" class="hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800" id="stockTitle"></h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        
                        <!-- 1. Price Trend Prediction -->
                        <div class="dashboard-card text-center bg-blue-500 text-white">
                            <p class="text-sm font-light opacity-80">AI 7-Day Trend Prediction</p>
                            <div class="flex items-center justify-center my-2">
                                <span id="trendIcon" class="text-6xl font-extrabold">?</span>
                            </div>
                            <p class="text-3xl font-bold" id="trendText">...</p>
                            <p class="text-sm opacity-80" id="trendConfidence">Confidence: --%</p>
                        </div>

                        <!-- 2. News & Sentiment Analysis -->
                        <div class="dashboard-card text-center">
                            <p class="text-sm font-medium text-gray-500">Market News Sentiment</p>
                            <div class="flex items-center justify-center my-2">
                                <span id="sentimentIcon" class="text-4xl">üòê</span>
                            </div>
                            <p class="text-2xl font-bold text-gray-800" id="sentimentText">Neutral</p>
                            <p class="text-sm text-gray-400" id="sentimentSource">Score: 0.0</p>
                        </div>

                        <!-- 3. Final Suggestion -->
                        <div class="dashboard-card text-center bg-green-500 text-white">
                            <p class="text-sm font-light opacity-80">Final AI Suggestion</p>
                            <div class="flex items-center justify-center my-2">
                                <span id="suggestionIcon" class="text-6xl">‚ùì</span>
                            </div>
                            <p class="text-3xl font-bold" id="suggestionText">HOLD</p>
                            <p class="text-sm opacity-80" id="suggestionConfidence">Based on AI/Indicators</p>
                        </div>
                    </div>

                    <!-- Technical & Risk Summary -->
                    <div class="dashboard-card">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Technical & Risk Summary</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-500">Relative Strength Index (RSI)</p>
                                <p class="text-lg font-bold text-gray-800" id="rsiValue">30.5 (Oversold)</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-sm text-gray-500">Risk Level (Simulated)</p>
                                <p class="text-lg font-bold text-red-500" id="riskLevel">Medium-High</p>
                            </div>
                        </div>
                        <p class="mt-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r text-blue-700 italic" id="alertMessage">
                            üîî Alert: Price expected to stabilize after recent volatility.
                        </p>
                    </div>
                </div>
            </main>

            <!-- Chatbot Panel (Col Span 1) -->
            <aside class="lg:col-span-1">
                <div class="dashboard-card h-full flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">
                        <span class="text-blue-500">Gemini</span> Financial Assistant
                    </h2>
                    
                    <!-- Chat History -->
                    <div id="chatHistory" class="chat-history flex-grow overflow-y-auto space-y-4 pr-2 mb-4">
                        <!-- Initial message from AI -->
                        <div class="flex justify-start">
                            <div class="bg-gray-200 text-gray-800 p-3 rounded-xl rounded-bl-none max-w-[80%] shadow-sm">
                                Hello! I'm your AI financial assistant. Ask me anything about stock news, market trends, or company earnings.
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="mt-auto">
                        <div id="chatLoading" class="text-sm text-blue-500 mb-2 hidden">
                            <svg class="animate-spin h-4 w-4 mr-2 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Thinking...
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatInput" placeholder="Ask a financial question..."
                                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                   onkeypress="if(event.key === 'Enter') document.getElementById('sendChatButton').click()">
                            <button id="sendChatButton"
                                    class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md disabled:bg-blue-400">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // --- Configuration & Initialization ---

        // The API Key is intentionally left blank. The environment will provide it at runtime.
        const API_KEY = "";
        const API_URL = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY};
        
        // --- DOM Elements ---
        const stockSymbolInput = document.getElementById('stockSymbol');
        const analyzeButton = document.getElementById('analyzeButton');
        const messageArea = document.getElementById('messageArea');
        const resultsDashboard = document.getElementById('resultsDashboard');
        const stockTitle = document.getElementById('stockTitle');
        
        // Results fields
        const trendIcon = document.getElementById('trendIcon');
        const trendText = document.getElementById('trendText');
        const trendConfidence = document.getElementById('trendConfidence');
        const sentimentIcon = document.getElementById('sentimentIcon');
        const sentimentText = document.getElementById('sentimentText');
        const sentimentSource = document.getElementById('sentimentSource');
        const suggestionIcon = document.getElementById('suggestionIcon');
        const suggestionText = document.getElementById('suggestionText');
        const suggestionConfidence = document.getElementById('suggestionConfidence');
        const rsiValue = document.getElementById('rsiValue');
        const riskLevel = document.getElementById('riskLevel');
        const alertMessage = document.getElementById('alertMessage');

        // Chat elements
        const chatHistory = document.getElementById('chatHistory');
        const chatInput = document.getElementById('chatInput');
        const sendChatButton = document.getElementById('sendChatButton');
        const chatLoading = document.getElementById('chatLoading');


        // --- Core Application Logic ---

        /**
         * Simulates a backend AI/Data fetch. In a real app, this would call a Python API.
         * The prediction values are randomized to showcase the dashboard structure.
         * @param {string} symbol - The stock symbol.
         * @returns {Object} Mock analysis data.
         */
        function mockStockAnalysis(symbol) {
            const symbols = {
                'RELIANCE': {
                    trend: 'Up', confidence: 78, sentiment: 'Positive', sentimentScore: 0.85, suggestion: 'BUY', rsi: 32.5, risk: 'Medium-Low',
                    alert: 'Price expected to show moderate growth driven by recent sector-specific policy changes.'
                },
                'GOOGL': {
                    trend: 'Flat', confidence: 55, sentiment: 'Neutral', sentimentScore: 0.10, suggestion: 'HOLD', rsi: 60.1, risk: 'Low',
                    alert: 'Current price is stable near resistance. Waiting for next earnings report for direction.'
                },
                'AMZN': {
                    trend: 'Down', confidence: 68, sentiment: 'Negative', sentimentScore: -0.65, suggestion: 'SELL', rsi: 80.2, risk: 'Medium-High',
                    alert: 'Technical indicators show overbought conditions. A correction is highly likely this week.'
                }
            };

            const data = symbols[symbol.toUpperCase()];

            if (data) {
                // Add some randomization to confidence/RSI to make it feel dynamic
                data.confidence = Math.min(95, data.confidence + Math.floor(Math.random() * 10 - 5));
                data.rsi = (data.rsi + Math.random() * 5 - 2.5).toFixed(1);
                return data;
            }

            // Default fallback for any other symbol
            return {
                trend: ['Up', 'Down', 'Flat'][Math.floor(Math.random() * 3)],
                confidence: Math.floor(Math.random() * 40) + 50, // 50-90%
                sentiment: ['Positive', 'Negative', 'Neutral'][Math.floor(Math.random() * 3)],
                sentimentScore: (Math.random() * 2 - 1).toFixed(2), // -1.00 to 1.00
                suggestion: ['BUY', 'SELL', 'HOLD'][Math.floor(Math.random() * 3)],
                rsi: (Math.random() * 70 + 15).toFixed(1), // 15.0 to 85.0
                risk: ['Low', 'Medium', 'Medium-High', 'High'][Math.floor(Math.random() * 4)],
                alert: No specific model found. Generated generic analysis for ${symbol.toUpperCase()}.
            };
        }


        /**
         * Renders the analysis results to the dashboard UI.
         * @param {string} symbol - The stock symbol.
         * @param {Object} data - The analysis data.
         */
        function renderAnalysis(symbol, data) {
            resultsDashboard.classList.remove('hidden');
            stockTitle.textContent = Analysis for ${symbol.toUpperCase()};
            
            // 1. Trend
            let trendClass, trendSymbol;
            if (data.trend === 'Up') { trendClass = 'icon-up'; trendSymbol = 'üìà'; }
            else if (data.trend === 'Down') { trendClass = 'icon-down'; trendSymbol = 'üìâ'; }
            else { trendClass = 'icon-flat'; trendSymbol = '‚ûñ'; }
            
            trendIcon.textContent = trendSymbol;
            trendIcon.className = text-6xl font-extrabold ${trendClass};
            trendText.textContent = data.trend;
            trendConfidence.textContent = Confidence: ${data.confidence}%;

            // 2. Sentiment
            let sentimentClass, sentimentEmoji;
            if (data.sentiment === 'Positive') { sentimentClass = 'text-green-500'; sentimentEmoji = 'üëç'; }
            else if (data.sentiment === 'Negative') { sentimentClass = 'text-red-500'; sentimentEmoji = 'üëé'; }
            else { sentimentClass = 'text-yellow-500'; sentimentEmoji = 'üòê'; }

            sentimentIcon.textContent = sentimentEmoji;
            sentimentIcon.className = text-4xl ${sentimentClass};
            sentimentText.textContent = data.sentiment;
            sentimentSource.textContent = Score: ${data.sentimentScore};

            // 3. Suggestion
            let suggestionBg, suggestionEmoji;
            if (data.suggestion === 'BUY') { suggestionBg = 'bg-green-600'; suggestionEmoji = '‚úî'; }
            else if (data.suggestion === 'SELL') { suggestionBg = 'bg-red-600'; suggestionEmoji = '‚ùó'; }
            else { suggestionBg = 'bg-yellow-600'; suggestionEmoji = '‚ûñ'; }

            document.querySelector('#resultsDashboard .md\\:grid-cols-3 > :nth-child(3)').className = dashboard-card text-center ${suggestionBg} text-white;
            suggestionIcon.textContent = suggestionEmoji;
            suggestionIcon.className = 'text-6xl';
            suggestionText.textContent = data.suggestion;
            suggestionConfidence.textContent = Confidence: ${data.confidence}%;

            // 4. Summary
            rsiValue.textContent = ${data.rsi} (${data.rsi < 30 ? 'Oversold - Good Zone' : data.rsi > 70 ? 'Overbought - Warning' : 'Neutral'});
            riskLevel.textContent = data.risk;
            riskLevel.className = text-lg font-bold ${data.risk.includes('High') ? 'text-red-500' : data.risk.includes('Low') ? 'text-green-500' : 'text-yellow-500'};
            alertMessage.textContent = üîî Alert: ${data.alert};

            messageArea.textContent = '';
        }

        /**
         * Main function to handle stock analysis button click.
         */
        async function fetchStockAnalysis() {
            const symbol = stockSymbolInput.value.trim().toUpperCase();
            if (!symbol) {
                messageArea.textContent = 'Please enter a stock symbol.';
                return;
            }
            
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = <svg class="animate-spin h-5 w-5 mr-1 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyzing...;

            // Simulate the delay of the backend analysis
            await new Promise(resolve => setTimeout(resolve, 1500));

            try {
                const analysisData = mockStockAnalysis(symbol);
                renderAnalysis(symbol, analysisData);
            } catch (error) {
                console.error("Analysis simulation failed:", error);
                messageArea.textContent = 'Error during analysis simulation. Check console.';
            } finally {
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13.75M9 19C7.895 19 7 18.105 7 17s.895-2 2-2 2 .895 2 2-.895 2-2 2zm12 0c-1.105 0-2-.895-2-2s.895-2 2-2 2 .895 2 2-.895 2-2 2zM9 17v-1.25M21 17v-1.25"></path></svg> Analyze Stock;
            }
        }

        analyzeButton.addEventListener('click', fetchStockAnalysis);


        // --- Gemini Chatbot Logic ---

        /**
         * Adds a message to the chat history.
         * @param {string} text - The message content.
         * @param {string} sender - 'user' or 'ai'.
         * @param {Array<Object>} [sources=[]] - Array of sources for the AI message.
         */
        function addMessageToChat(text, sender, sources = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = flex ${sender === 'user' ? 'justify-end' : 'justify-start'};
            
            const contentDiv = document.createElement('div');
            contentDiv.className = `p-3 rounded-xl max-w-[85%] shadow-md ${
                sender === 'user'
                    ? 'bg-blue-600 text-white rounded-br-none'
                    : 'bg-gray-200 text-gray-800 rounded-bl-none'
            }`;
            contentDiv.innerHTML = text; // Use innerHTML to process markdown/links

            if (sender === 'ai' && sources.length > 0) {
                const sourcesHtml = sources.map(s => 
                    <a href="${s.uri}" target="_blank" class="text-xs text-blue-500 hover:underline block truncate">${s.title || new URL(s.uri).hostname}</a>
                ).join('');
                const sourcesContainer = document.createElement('div');
                sourcesContainer.className = 'mt-2 pt-2 border-t border-gray-300 text-xs text-gray-500';
                sourcesContainer.innerHTML = 'Source(s): ' + sourcesHtml;
                contentDiv.appendChild(sourcesContainer);
            }

            messageDiv.appendChild(contentDiv);
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to bottom
        }

        /**
         * Fetches response from the Gemini API with Google Search grounding.
         * @param {string} query - The user's question.
         */
        async function fetchChatbotResponse(query) {
            // Add user message to UI
            addMessageToChat(query, 'user');
            
            // Show loading indicator and disable input
            chatLoading.classList.remove('hidden');
            chatInput.disabled = true;
            sendChatButton.disabled = true;

            const systemPrompt = "You are a concise, helpful financial analyst and investment assistant. Answer questions based on real-time market data and news. Keep responses direct and professional and use markdown for formatting.";

            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            let currentDelay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            console.warn(Rate limit exceeded. Retrying in ${currentDelay / 1000}s...);
                            await new Promise(res => setTimeout(res, currentDelay));
                            currentDelay *= 2; // Exponential backoff
                            continue; // Retry the loop
                        }
                        throw new Error(API call failed with status: ${response.status});
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri);
                        }

                        addMessageToChat(text, 'ai', sources);
                    } else {
                        addMessageToChat("I'm sorry, I couldn't generate a meaningful response.", 'ai');
                    }
                    break; // Success, exit loop

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    if (i === maxRetries - 1) {
                        addMessageToChat("There was an error connecting to the financial AI. Please try again later.", 'ai');
                    }
                }
            }
            
            // Re-enable input and hide loading
            chatLoading.classList.add('hidden');
            chatInput.disabled = false;
            sendChatButton.disabled = false;
            chatInput.value = ''; // Clear input
            chatInput.focus();
        }

        sendChatButton.addEventListener('click', () => {
            const query = chatInput.value.trim();
            if (query) {
                fetchChatbotResponse(query);
            }
        });
        
    </script>
</body>
</html>